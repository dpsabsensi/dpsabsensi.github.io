(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function r(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(t){if(t.ep)return;t.ep=!0;const s=r(t);fetch(t.href,s)}})();const B="08:00",H="16:00",D="14:00",v=5,K=5e3;document.getElementById("upload-form").addEventListener("submit",async function(e){e.preventDefault();const n=document.querySelector('input[type="file"]'),r=new FormData;r.append("csvFile",n.files[0]);const a=document.getElementById("message");a.innerText="⏳ Uploading...";try{const s=await(await fetch("https://pusatpneumatic.com/absen/upload.php",{method:"POST",body:r})).text();let o;try{o=JSON.parse(s)}catch(c){console.error("Error parsing JSON dari upload.php:",c.message,s),a.innerText="❌ Upload gagal: Respons server bukan JSON valid. Periksa console log.";return}if(!o.success){a.innerText="❌ Upload gagal: "+o.message;return}a.innerText="✅ Sukses! Data berhasil diparse",console.log("Parsed data:",o.parse_log),o.parse_log&&o.parse_log.data&&console.log("User Logs:",o.parse_log.data)}catch(t){a.innerText="❌ Terjadi kesalahan: "+t.message}});function S(e){if(!e)return null;const[n,r]=e.split(":").map(Number);return n*60+r}function L(e){const n=Math.floor(e/60),r=e%60;return`${n}j ${r}m`}function C(e){return Math.floor(e/60)*5e3}function N(e){return new Date(e).getDay()===6}function J(e){if(!e)return"";if(e instanceof Date){const r=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),t=String(e.getDate()).padStart(2,"0");return`${r}-${a}-${t}`}let n=String(e).trim();if(n.includes("/")){const[r,a,t]=n.split("/");if(r.length<=2&&a.length<=2&&t.length===4)return`${t}-${String(r).padStart(2,"0")}-${String(a).padStart(2,"0")}`;if(r.length===4)return`${r}-${String(a).padStart(2,"0")}-${String(t).padStart(2,"0")}`}if(n.includes("-")){const[r,a,t]=n.split("-");if(r.length===4)return`${r}-${String(a).padStart(2,"0")}-${String(t).padStart(2,"0")}`}return n}function _(e){return Object.entries(e).map(([n,r])=>{const a=r.l||[];let t=null,s=null;const o=[];return a.forEach((c,m)=>{const[k,f]=c;if(f===0&&!t&&(t=k),f===1&&(s=k),m<a.length-1){const[j,b]=a[m+1];if(f===3&&b===2){const w=S(j)-S(k);w>0&&o.push(w)}}}),{tanggal:J(n),jamMasuk:t,jamKeluar:s,breaks:o,isEmpty:!t&&!s,holiday:r.s===2,status:r.s}})}function R(e){if(!e||e.length===0)return{workMinutes:0,workHours:"0j 0m",lemburHours:"0j 0m",uangLemburKotor:0,jamKerjaIdeal:"0j 0m",dendaTelat:0,uangLembur:0,telatHours:"0j 0m",earlyOutHours:"0j 0m",absenceDays:0,missingDays:0,holidayDays:0,breakHours:"0j 0m"};let n=0,r=0,a=0,t=0,s=0,o=0,c=0,m=0;const k=new Set;e.forEach(d=>{if(d.holiday&&!d.jamMasuk&&!d.jamKeluar){m++;return}if(k.add(d.tanggal),!d.jamMasuk||!d.jamKeluar){c++;return}const x=S(d.jamMasuk),E=S(d.jamKeluar),l=S(N(d.tanggal)?D:H),y=E-x;n+=y;const p=x-S(B);p>v&&(s+=p,t+=C(p));const h=l-E;h>v&&(o+=h);const u=E-l;u>v&&(r+=u),a+=d.breaks.reduce((T,i)=>T+i,0)});const f=e.filter(d=>!d.holiday&&d.isEmpty).length,j=Math.floor(r/60)*K,b=Math.max(j-t,0),w=e.reduce((d,x)=>{if(x.holiday)return d;const E=S(N(x.tanggal)?D:H),l=S(B);return d+(E-l)},0);return{workMinutes:n,workHours:L(n),lemburHours:L(r),uangLemburKotor:j,jamKerjaIdeal:L(w),dendaTelat:t,uangLembur:b,telatHours:L(s),earlyOutHours:L(o),absenceDays:f,missingDays:c,holidayDays:m,breakHours:L(a)}}function P({summaryId:e,detailId:n,tabSummaryId:r,tabDetailId:a}){const t=document.getElementById(r),s=document.getElementById(a),o=document.getElementById(e),c=document.getElementById(n);t.addEventListener("click",()=>{o.classList.remove("hidden"),c.classList.add("hidden"),t.classList.replace("bg-gray-200","bg-blue-600"),t.classList.replace("text-gray-700","text-white"),s.classList.replace("bg-blue-600","bg-gray-200"),s.classList.replace("text-white","text-gray-700")}),s.addEventListener("click",()=>{o.classList.add("hidden"),c.classList.remove("hidden"),s.classList.replace("bg-gray-200","bg-blue-600"),s.classList.replace("text-gray-700","text-white"),t.classList.replace("bg-blue-600","bg-gray-200"),t.classList.replace("text-white","text-gray-700")})}let I={};async function O(e){if(I[e])return I[e];const n=await fetch(`https://libur.deno.dev/api?year=${e}`);if(!n.ok)throw new Error("Gagal fetch tanggal merah");const r=await n.json(),a={};return r.forEach(t=>{t.is_national_holiday&&(a[t.date]=!0)}),I[e]=a,a}async function U(e){const n=document.getElementById("yearSelect"),r=document.getElementById("monthSelect");Object.keys(e).sort().forEach(c=>{const m=document.createElement("option");m.value=c,m.textContent=c,n.appendChild(m)});const a=new Date,t=a.getFullYear().toString(),s=String(a.getMonth()+1).padStart(2,"0");n.value=t;const o=e[t];return o&&(r.innerHTML="",o.forEach(c=>{const m=document.createElement("option");m.value=c,m.textContent=c,r.appendChild(m)}),r.value=s),await O(t),{year:t,month:s}}async function F(e,n){const r=document.getElementById("monthSelect"),a=e[n]||[];return r.innerHTML="",a.forEach(t=>{const s=document.createElement("option");s.value=t,s.textContent=t,r.appendChild(s)}),await O(n),a[0]||null}document.addEventListener("DOMContentLoaded",async()=>{function e(){const a=document.getElementById("yearSelect")?.value,t=document.getElementById("monthSelect")?.value;return`https://pusatpneumatic.com/absen/json/${a}/${a}-${t}.json`}async function n(){const a=e();try{let d=function(){const l=m.value.toLowerCase();b.querySelectorAll("tr").forEach(y=>{const p=y.children[0].textContent.toLowerCase();y.style.display=p.includes(l)?"":"none"}),f.querySelectorAll("tr").forEach(y=>{const p=y.children[0].textContent.toLowerCase();y.style.display=p.includes(l)?"":"none"})},E=function(l,y=!1){const p=Array.from(b.querySelectorAll("tr")),h=x[l]==="asc"?"desc":"asc";x[l]=h,p.sort((u,T)=>{const i=u.children[l].textContent.trim(),g=T.children[l].textContent.trim();let M;return y?M=new Date(i)-new Date(g):!isNaN(i)&&!isNaN(g)?M=Number(i)-Number(g):M=i.localeCompare(g),h==="asc"?M:-M}),b.innerHTML="",p.forEach(u=>b.appendChild(u))};var t=d,s=E;const o=await fetch(a);if(!o.ok)throw new Error("Gagal memuat data JSON");const c=await o.json(),m=document.getElementById("filterName"),k=document.getElementById("summaryHead"),f=document.getElementById("summaryBody"),j=document.getElementById("detailHead"),b=document.getElementById("detailBody");f.innerHTML="",b.innerHTML="",k.innerHTML=`
        <tr>
          <th class="px-4 py-3 border-b text-left">Nama</th>
          <th class="px-4 py-3 border-b text-center">Work</th>
          <th class="px-4 py-3 border-b text-center">Lembur (jam)</th>
          <th class="px-4 py-3 border-b text-center">Uang Lembur</th>
          <th class="px-4 py-3 border-b text-center">Telat (jam)</th>
          <th class="px-4 py-3 border-b text-center">Early Out</th>
          <th class="px-4 py-3 border-b text-center">Absence</th>
          <th class="px-4 py-3 border-b text-center">Break (jam)</th>
        </tr>
      `,j.innerHTML=`
        <tr class="bg-gradient-to-r from-blue-200 to-blue-400 text-gray-800 font-semibold text-sm shadow-sm">
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="nama">Nama</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="tanggal">Tanggal</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="masuk">Jam Masuk</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="breakout">Jam Break-Out</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="breakin">Jam Break-In</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="keluar">Jam Keluar</th>
          <th class="px-1 py-3 border-b border-gray-300 text-center rounded-tr-lg w-30">KET</th>
        </tr>
      `;const w=c.u||[];console.log("Users loaded:",w.map(l=>l.n));for(const l of w){const y=l.n,p=l.d||{},h=_(p),u=await R(h);h.length===0&&h.push({tanggal:"-",jamMasuk:"-",jamKeluar:"-",breaks:[],status:0,holiday:0}),h.forEach(i=>{let g="";i.status===1?g="Tidak hadir":i.status===2?g="Libur":i.isEmpty?g="Missing Time":i.holiday===1&&(g="Tanggal Merah");const M=i.breaks.length?L(i.breaks[0]):"-",A=i.breaks.length?L(i.breaks[i.breaks.length-1]):"-",$=document.createElement("tr");$.className="hover:bg-blue-50 transition-colors",$.innerHTML=`
            <td class="px-4 py-3 border-b text-sm font-medium text-gray-700">${y}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-gray-600">${i.tanggal}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-green-700 font-semibold">${i.jamMasuk||"-"}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-red-700 font-semibold">${M}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-red-700 font-semibold">${A}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-red-700 font-semibold">${i.jamKeluar||"-"}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-blue-700">${g}</td>
          `,b.appendChild($)});const T=document.createElement("tr");T.className="hover:bg-blue-50 transition-colors",T.innerHTML=`
          <td class="px-4 py-3 text-sm font-medium text-gray-800">${y}</td>
          <td class="px-4 py-3 text-center">${u.workHours}</td>
          <td class="px-4 py-3 text-center text-green-700 font-semibold">${u.lemburHours}</td>
          <td class="px-4 py-3 text-center font-semibold relative group cursor-pointer ${u.uangLembur<0?"text-red-700":"text-green-800"}">
            Rp${u.uangLembur.toLocaleString()}
            <div class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-3 py-1 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
              Rp${u.uangLemburKotor.toLocaleString()} - Rp${u.dendaTelat.toLocaleString()}
            </div>
          </td>
          <td class="px-4 py-3 text-center text-red-700">${u.telatHours}</td>
          <td class="px-4 py-3 text-center">${u.earlyOutHours}</td>
          <td class="px-4 py-3 text-center">${u.absenceDays}</td>
          <td class="px-4 py-3 text-center">${u.breakHours}</td>
        `,f.appendChild(T)}let x={};j.querySelectorAll("th").forEach((l,y)=>{const p=l.dataset.sort;p&&l.addEventListener("click",()=>E(y,p==="tanggal"))}),m.addEventListener("input",d)}catch(o){console.error("❌ Gagal memuat JSON:",o);const c=document.getElementById("message");c&&(c.innerText="Gagal memuat data. Periksa file JSON.")}}async function r(){const t=await(await fetch("https://pusatpneumatic.com/absen/json/list_index.json")).json(),{year:s}=await U(t),o=document.getElementById("yearSelect"),c=document.getElementById("monthSelect");o.addEventListener("change",async()=>{await F(t,o.value),n()}),c.addEventListener("change",n),n()}await r(),P({summaryId:"summaryTab",detailId:"detailTab",tabSummaryId:"tabSummary",tabDetailId:"tabDetail"})});
