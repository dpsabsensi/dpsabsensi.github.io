(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function l(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function r(t){if(t.ep)return;t.ep=!0;const e=l(t);fetch(t.href,e)}})();const B="https://pusatpneumatic.com/absen",A=480,K=960,N=840,H=5,O=5e3;document.getElementById("upload-form").addEventListener("submit",async function(o){o.preventDefault();const a=document.querySelector('input[type="file"]'),l=new FormData;l.append("csvFile",a.files[0]);const r=document.getElementById("message");r.innerText="⏳ Uploading...";try{const e=await(await fetch(`${B}/upload.php`,{method:"POST",body:l})).text();let n;try{n=JSON.parse(e)}catch(c){console.error("Error parsing JSON dari upload.php:",c.message,e),r.innerText="❌ Upload gagal: Respons server bukan JSON valid. Periksa console log.";return}if(!n.success){r.innerText="❌ Upload gagal: "+n.message;return}r.innerText="✅ Sukses! Data berhasil diparse",console.log("Parsed data:",n.parse_log),n.parse_log&&n.parse_log.data&&console.log("User Logs:",n.parse_log.data)}catch(t){r.innerText="❌ Terjadi kesalahan: "+t.message}});function b(o){if(o==null)return"-";const a=Math.floor(o/60),l=String(o%60).padStart(2,"0");return`${a}:${l}`}const J=[[5,0],[15,1e4],[30,25e3],[60,5e4],[1/0,1e5]];function C(o){return J.find(([a])=>o<=a)[1]}function _(o){return new Date(o).getDay()===6}function P(o){const a=o.i||{},l=a.m||0,r=a.k||0,t=a.l||0;return{minutes:l,formatted:b(l),hariKerja:r,hariLibur:t}}function R({summaryId:o,detailId:a,tabSummaryId:l,tabDetailId:r}){const t=document.getElementById(l),e=document.getElementById(r),n=document.getElementById(o),c=document.getElementById(a);t.addEventListener("click",()=>{n.classList.remove("hidden"),c.classList.add("hidden"),t.classList.replace("bg-gray-200","bg-blue-600"),t.classList.replace("text-gray-700","text-white"),e.classList.replace("bg-blue-600","bg-gray-200"),e.classList.replace("text-white","text-gray-700")}),e.addEventListener("click",()=>{n.classList.add("hidden"),c.classList.remove("hidden"),e.classList.replace("bg-gray-200","bg-blue-600"),e.classList.replace("text-gray-700","text-white"),t.classList.replace("bg-blue-600","bg-gray-200"),t.classList.replace("text-white","text-gray-700")}),e.addEventListener("click",()=>{n.classList.add("hidden"),c.classList.remove("hidden"),e.classList.replace("bg-gray-200","bg-blue-600"),e.classList.replace("text-gray-700","text-white"),t.classList.replace("bg-blue-600","bg-gray-200"),t.classList.replace("text-white","text-gray-700")})}function U(o){return Array.isArray(o)?o.map((a,l)=>{const r=l+1;if(typeof a=="number")return{tanggal:r,jamMasuk:null,jamKeluar:null,breaks:[],isEmpty:!0,holiday:a===2,status:a};const t=a.l||[];let e=null,n=null;const c=[];return t.forEach((p,S)=>{const[f,k]=p;if(k===0&&!e&&(e=f),k===1&&(n=f),S<t.length-1){const[h,x]=t[S+1];if(k===2&&x===3){const T=h-f;T>0&&c.push(T)}}}),{tanggal:r,jamMasuk:e,jamKeluar:n,breaks:c,isEmpty:!e&&!n,holiday:a.s===2,status:a.s}}):(console.warn("normalizeLogs: input bukan array",o),[])}async function F(o,a,l=""){if(!o||o.length===0)return{workMinutes:0,workHours:"00:00",lemburHours:"00:00",uangLemburKotor:0,jamKerjaIdeal:"00:00",dendaTelat:0,uangLembur:0,telatHours:"00:00",earlyOutHours:"00:00",absenceDays:0,missingDays:0,holidayDays:0,breakHours:"00:00"};let r=0,t=0,e=0,n=0,c=0,p=0,S=0,f=0;const k=new Set,h=[],x=[];o.forEach(s=>{if(s.holiday&&!s.jamMasuk&&!s.jamKeluar){f++;return}if(k.add(s.tanggal),!s.jamMasuk||!s.jamKeluar){S++;return}const d=s.jamMasuk,u=s.jamKeluar,g=_(s.tanggal)?N:K,m=u-d;r+=m;const L=d-A;if(L>H){c+=L;const w=C(L);n+=w,h.push({tanggal:s.tanggal,telat:L,denda:w})}const i=g-u;i>H&&(p+=i);const y=u-g;y>H&&(t+=y,x.push({tanggal:s.tanggal,lembur:y}));const E=s.breaks.reduce((w,$)=>w+$,0);e+=E});const T=o.filter(s=>!s.holiday&&s.isEmpty).length,M=Math.floor(t/60)*O,I=Math.max(M-n,0),j=r-a.minutes;if(a){const s=x.map(u=>u.lembur).join(" + "),d=x.reduce((u,g)=>u+g.lembur,0);console.log(`[ ${l} ]
      Total Kerja  : ${b(r)} (${r} menit),
      Selisih      : ${b(j)} (${j} menit)
      Lembur Harian: ${s} = ${d} menit (${b(d)})`)}return{workMinutes:r,workHours:b(r),lemburHours:b(t),uangLemburKotor:M,dendaTelat:n,uangLembur:I,telatHours:b(c),earlyOutHours:b(p),absenceDays:T,missingDays:S,holidayDays:f,breakHours:b(e),dendaPerHari:h}}async function q(o){const a=document.getElementById("yearSelect"),l=document.getElementById("monthSelect");Object.keys(o).sort().forEach(c=>{const p=document.createElement("option");p.value=c,p.textContent=c,a.appendChild(p)});const r=new Date,t=r.getFullYear().toString(),e=String(r.getMonth()+1).padStart(2,"0");a.value=t;const n=o[t];return n&&(l.innerHTML="",n.forEach(c=>{const p=document.createElement("option");p.value=c,p.textContent=c,l.appendChild(p)}),l.value=e),{year:t,month:e}}async function Y(o,a){const l=document.getElementById("monthSelect"),r=o[a]||[];return l.innerHTML="",r.forEach(t=>{const e=document.createElement("option");e.value=t,e.textContent=t,l.appendChild(e)}),r[0]||null}document.addEventListener("DOMContentLoaded",async()=>{function o(){const r=document.getElementById("yearSelect")?.value,t=document.getElementById("monthSelect")?.value;return`${B}/json/${r}/${r}-${t}.json`}async function a(){const r=o();try{let M=function(){const s=p.value.toLowerCase();h.querySelectorAll("tr").forEach(d=>{const u=d.children[0].textContent.toLowerCase();d.style.display=u.includes(s)?"":"none"}),f.querySelectorAll("tr").forEach(d=>{const u=d.children[0].textContent.toLowerCase();d.style.display=u.includes(s)?"":"none"})},j=function(s,d=!1){const u=Array.from(h.querySelectorAll("tr")),g=I[s]==="asc"?"desc":"asc";I[s]=g,u.sort((m,L)=>{const i=m.children[s].textContent.trim(),y=L.children[s].textContent.trim();let E;return d?E=new Date(i)-new Date(y):!isNaN(i)&&!isNaN(y)?E=Number(i)-Number(y):E=i.localeCompare(y),g==="asc"?E:-E}),h.innerHTML="",u.forEach(m=>h.appendChild(m))};var t=M,e=j;const n=await fetch(r);if(!n.ok)throw new Error("Gagal memuat data JSON");const c=await n.json(),p=document.getElementById("filterName"),S=document.getElementById("summaryHead"),f=document.getElementById("summaryBody"),k=document.getElementById("detailHead"),h=document.getElementById("detailBody"),x=P(c);console.log(`
      ================================================
      Jam kerja ideal bulan ini: ${x.formatted} (${x.minutes} menit)
      ================================================`),f.innerHTML="",h.innerHTML="",S.innerHTML=`
        <tr>
          <th class="px-4 py-3 border-b text-left">Nama</th>
          <th class="px-4 py-3 border-b text-center">Work<br>${x.formatted}</th>
          <th class="px-4 py-3 border-b text-center">Lembur (jam)</th>
          <th class="px-4 py-3 border-b text-center">Uang Lembur</th>
          <th class="px-4 py-3 border-b text-center">Telat (jam)</th>
          <th class="px-4 py-3 border-b text-center">Early Out</th>
          <th class="px-4 py-3 border-b text-center">Absence</th>
          <th class="px-4 py-3 border-b text-center">Break (jam)</th>
        </tr>
      `,k.innerHTML=`
        <tr class="bg-gradient-to-r from-blue-200 to-blue-400 text-gray-800 font-semibold text-sm shadow-sm">
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="nama">Nama</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="tanggal">Tanggal</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="masuk">Jam Masuk</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="breakout">Jam Break-Out</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="breakin">Jam Break-In</th>
          <th class="px-4 py-3 border-b border-gray-300 text-center cursor-pointer" data-sort="keluar">Jam Keluar</th>
          <th class="px-1 py-3 border-b border-gray-300 text-center rounded-tr-lg w-30">KET</th>
        </tr>
      `;const T=c.u||[];for(const s of T){const d=s.n,u=(s.d||[]).map(i=>typeof i=="number"?{s:i,l:[]}:i),g=U(u),m=await F(g,x,d);g.length===0&&g.push({tanggal:"-",jamMasuk:"-",jamKeluar:"-",breaks:[],status:0,holiday:0}),g.forEach(i=>{let y="";i.status===1?y="Tidak hadir":i.status===2?y="Libur":i.isEmpty?y="Missing Time":i.holiday===1&&(y="Tanggal Merah");const E=b(i.jamMasuk),w=b(i.jamKeluar),$=i.breaks.length>=1?b(i.breaks[0]):"-",D=i.breaks.length>=2?b(i.breaks[i.breaks.length-1]):"-",v=document.createElement("tr");v.className="hover:bg-blue-50 transition-colors",v.innerHTML=`
            <td class="px-4 py-3 border-b text-sm font-medium text-gray-700">${d}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-gray-600">${i.tanggal}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-green-700 font-semibold">${E||"-"}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-red-700 font-semibold">${$}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-red-700 font-semibold">${D}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-red-700 font-semibold">${w||"-"}</td>
            <td class="px-4 py-3 border-b text-center text-sm text-blue-700">${y}</td>
          `,h.appendChild(v)});const L=document.createElement("tr");L.className="hover:bg-blue-50 transition-colors",L.innerHTML=`
          <td class="px-4 py-3 text-sm font-medium text-gray-800">${d}</td>
          <td class="px-4 py-3 text-center">${m.workHours}</td>
          <td class="px-4 py-3 text-center text-green-700 font-semibold">${m.lemburHours}</td>
          <td class="px-4 py-3 text-center font-semibold relative group cursor-pointer ${m.uangLembur<0?"text-red-700":"text-green-800"}">
            Rp${m.uangLembur.toLocaleString()}
            <div class="absolute z-10 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-3 py-1 bg-gray-700 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
              Rp${m.uangLemburKotor.toLocaleString()} - Rp${m.dendaTelat.toLocaleString()}
            </div>
          </td>
          <td class="px-4 py-3 text-center text-red-700">${m.telatHours}</td>
          <td class="px-4 py-3 text-center">${m.earlyOutHours}</td>
          <td class="px-4 py-3 text-center">${m.absenceDays}</td>
          <td class="px-4 py-3 text-center">${m.breakHours}</td>
        `,f.appendChild(L)}let I={};k.querySelectorAll("th").forEach((s,d)=>{const u=s.dataset.sort;u&&s.addEventListener("click",()=>j(d,u==="tanggal"))}),p.addEventListener("input",M)}catch(n){console.error("❌ Gagal memuat JSON:",n);const c=document.getElementById("message");c&&(c.innerText="Gagal memuat data. Periksa file JSON.")}}async function l(){const t=await(await fetch(`${B}/json/list_index.json`)).json(),{year:e}=await q(t),n=document.getElementById("yearSelect"),c=document.getElementById("monthSelect");n.addEventListener("change",async()=>{await Y(t,n.value),a()}),c.addEventListener("change",a),a()}await l(),R({summaryId:"summaryTab",detailId:"detailTab",tabSummaryId:"tabSummary",tabDetailId:"tabDetail"})});
